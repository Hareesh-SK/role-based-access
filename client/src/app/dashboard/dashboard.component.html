<div class="dashboard-container">
  
  <div class="header flex items-center gap-3 mb-4">
    <div class="logout-wrapper" (click)="confirmLogout()" matTooltip="Logout">
      <mat-icon class="logout-icon">power_settings_new</mat-icon>
      <div class="logout-text">Log Out</div>
    </div>

    <h2>Welcome, {{ currentUser?.name }} ({{ currentUser?.role }})</h2>

    @if (isAdmin) {
      @if (isEdit) {
        <button mat-raised-button color="primary" (click)="addUser()">Add User</button>
        <button mat-raised-button color="primary" (click)="toggleEdit()">Review Changes</button>
        <button mat-button color="warn" (click)="cancelEdit()">Cancel</button>
      } @else {
        <button mat-raised-button color="primary" (click)="toggleEdit()">Edit</button>
      }
    }
  </div>

  <!-- Pagination Top -->
  @if (totalPages > 1) {
    <div class="pagination flex items-center gap-3 mb-3">
      <button mat-stroked-button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">Prev</button>
      <span>Page {{ currentPage }} of {{ totalPages }}</span>
      <button mat-stroked-button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">Next</button>
    </div>
  }

  <table class="mat-elevation-z2 w-full">
    <thead>
      <tr>
        <th>User ID</th>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        @if (isEdit) {
          <th>Action</th>
        }
      </tr>
    </thead>
    <tbody>
      @for (user of paginatedUsers; track user._id) {
        <tr [class.new-row]="user.isNew" [class.deleted-row]="user.markedForDelete">
          <td>
            @if (isEdit) {
              <mat-form-field appearance="outline" class="w-40">
                <input matInput [(ngModel)]="user.userId" />
              </mat-form-field>
            } @else {
              {{ user.userId }}
            }
          </td>

          <td>
            @if (isEdit) {
              <mat-form-field appearance="outline" class="w-40">
                <input matInput [(ngModel)]="user.name" />
              </mat-form-field>
            } @else {
              {{ user.name }}
            }
          </td>

          <td>
            @if (isEdit) {
              <mat-form-field appearance="outline" class="w-60">
                <input matInput [(ngModel)]="user.email" />
              </mat-form-field>
            } @else {
              {{ user.email }}
            }
          </td>

          <td>
            @if (isEdit) {
              <mat-form-field appearance="outline">
                <mat-select [(ngModel)]="user.role">
                  <mat-option value="Admin">Admin</mat-option>
                  <mat-option value="General User">General User</mat-option>
                </mat-select>
              </mat-form-field>
            } @else {
              {{ user.role }}
            }
          </td>

          @if (isEdit) {
            <td>
              <div (click)="toggleDelete(user)">
                @if (!user.markedForDelete) {
                  <mat-icon color="warn">delete</mat-icon>
                } @else {
                  <mat-icon color="primary">undo</mat-icon>
                }
              </div>
            </td>
          }
        </tr>
      }
    </tbody>
  </table>

  <!-- Pagination Bottom -->
  @if (totalPages > 1) {
    <div class="pagination flex items-center gap-3 mt-3">
      <button mat-stroked-button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">Prev</button>
      <span>Page {{ currentPage }} of {{ totalPages }}</span>
      <button mat-stroked-button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">Next</button>
    </div>
  }
</div>

<!-- Logout Dialog -->
<ng-template #logoutDialog>
  <h2 mat-dialog-title>Confirm Logout</h2>
  <mat-dialog-content>Are you sure you want to log out?</mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancel</button>
    <button mat-button color="warn" [mat-dialog-close]="'confirm'">Logout</button>
  </mat-dialog-actions>
</ng-template>

<!-- Review Changes Dialog -->
<ng-template #reviewDialog let-data>
  <h2 mat-dialog-title>Review Changes</h2>
  <mat-dialog-content>
    <table class="mat-elevation-z2 w-full">
      <thead>
        <tr>
          <th>User ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        @for (u of data.newUsers; track u._id) {
          <tr>
            <td>{{ u.userId }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.role }}</td>
            <td>ðŸŸ¢ New</td>
          </tr>
        }

        @for (u of data.updatedUsers; track u._id) {
          <tr>
            <td>{{ u.userId }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.role }}</td>
            <td>ðŸŸ¡ Updated</td>
          </tr>
        }

        @for (u of data.deletedUsers; track u._id) {
          <tr class="deleted-row">
            <td>{{ u.userId }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.role }}</td>
            <td>ðŸ”´ Deleted</td>
          </tr>
        }
      </tbody>
    </table>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Cancel</button>
    <button mat-button color="primary" (click)="saveChanges(data)" mat-dialog-close>Confirm & Save</button>
  </mat-dialog-actions>
</ng-template>
