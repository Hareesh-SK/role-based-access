<div class="dashboard-container">
  
  <div class="header flex items-center gap-3 mb-4">
    <div class="logout-wrapper" (click)="confirmLogout()" >
      <mat-icon class="logout-icon">power_settings_new</mat-icon>
      <div class="logout-text">{{ 'DASHBOARD.LOGOUT_TEXT' | translate }}</div>
    </div>

    <h2>{{ 'DASHBOARD.WELCOME' | translate:{name: currentUser?.name, role: currentUser?.role} }}</h2>
    
    @if (isAdmin) {
      <div class="actions">
      @if (isEdit) {
        <button mat-raised-button color="primary" (click)="addUser()">{{ 'DASHBOARD.ADD_USER' | translate }}</button>
        <button mat-raised-button color="primary" (click)="toggleEdit()">{{ 'DASHBOARD.REVIEW_CHANGES' | translate }}</button>
        <button mat-button color="warn" (click)="cancelEdit()">{{ 'DASHBOARD.CANCEL' | translate }}</button>
      } @else {
        <button mat-raised-button color="primary" (click)="toggleEdit()">{{ 'DASHBOARD.EDIT' | translate }}</button>
      }
      </div>
    }
    
  </div>

  <!-- Pagination Top -->
  @if (totalPages > 1) {
    <div class="pagination flex items-center gap-3 mb-3">
      <button mat-stroked-button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">{{ 'DASHBOARD.PREV' | translate }}</button>
      <span>{{ 'DASHBOARD.PAGE_OF' | translate:{current: currentPage, total: totalPages} }}</span>
      <button mat-stroked-button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">{{ 'DASHBOARD.NEXT' | translate }}</button>
    </div>
  }

  <table class="mat-elevation-z2 w-full">
    <thead>
      <tr>
        <th>{{ 'DASHBOARD.USER_ID' | translate }}</th>
        <th>{{ 'DASHBOARD.NAME' | translate }}</th>
        <th>{{ 'DASHBOARD.EMAIL' | translate }}</th>
        <th>{{ 'DASHBOARD.ROLE' | translate }}</th>
        @if (isEdit) {
          <th>{{ 'DASHBOARD.ACTION' | translate }}</th>
        }
      </tr>
    </thead>
    <tbody>
      @for (user of paginatedUsers; track user._id) {
        <tr [class.new-row]="user.isNew" [class.deleted-row]="user.markedForDelete">
          <td>
            @if (isEdit) {
              <mat-form-field appearance="outline" class="w-40">
                <input matInput [(ngModel)]="user.userId" />
              </mat-form-field>
            } @else {
              {{ user.userId }}
            }
          </td>
          <td>
            @if (isEdit) {
              <mat-form-field appearance="outline" class="w-40">
                <input matInput [(ngModel)]="user.name" />
              </mat-form-field>
            } @else {
              {{ user.name }}
            }
          </td>
          <td>
            @if (isEdit) {
              <mat-form-field appearance="outline" class="w-60" [ngClass]="{'invalid-field': user.email && !isValidEmail(user.email)}">
                <input matInput [(ngModel)]="user.email" />
              </mat-form-field>
            } @else {
              {{ user.email }}
            }
          </td>
          <td>
            @if (isEdit) {
              <mat-form-field appearance="outline">
                <mat-select [(ngModel)]="user.role">
                  <mat-option value="Admin">{{ 'DASHBOARD.ADMIN' | translate }}</mat-option>
                  <mat-option value="General User">{{ 'DASHBOARD.GENERAL_USER' | translate }}</mat-option>
                </mat-select>
              </mat-form-field>
            } @else {
              {{ user.role }}
            }
          </td>
          @if (isEdit) {
            <td>
              @if (user.isNew) {
                <!-- Newly added row → delete immediately -->
                <mat-icon 
                  color="warn" 
                  matTooltip="{{ 'DASHBOARD.DELETE_TOOLTIP' | translate }}" 
                  (click)="deleteNewUser(user)">
                  {{ 'DASHBOARD.DELETE_ICON' | translate }}
                </mat-icon>
              } @else {
                <!-- Existing row → mark for delete / undo -->
                <div (click)="toggleDelete(user)">
                  @if (!user.markedForDelete) {
                    <mat-icon 
                      color="warn" 
                      matTooltip="{{ 'DASHBOARD.DELETE_TOOLTIP' | translate }}">
                      {{ 'DASHBOARD.DELETE_ICON' | translate }}
                    </mat-icon>
                  } @else {
                    <mat-icon 
                      color="primary" 
                      matTooltip="{{ 'DASHBOARD.UNDO_TOOLTIP' | translate }}">
                      {{ 'DASHBOARD.UNDO_ICON' | translate }}
                    </mat-icon>
                  }
                </div>
              }
            </td>

          }
        </tr>
      }
    </tbody>
  </table>

  <!-- Pagination Bottom -->
  @if (totalPages > 1) {
    <div class="pagination flex items-center gap-3 mt-3">
      <button mat-stroked-button (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">{{ 'DASHBOARD.PREV' | translate }}</button>
      <span>{{ 'DASHBOARD.PAGE_OF' | translate:{current: currentPage, total: totalPages} }}</span>
      <button mat-stroked-button (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">{{ 'DASHBOARD.NEXT' | translate }}</button>
    </div>
  }
</div>

<!-- Logout Dialog -->
<ng-template #logoutDialog>
  <h2 mat-dialog-title>{{ 'DASHBOARD.LOGOUT_TITLE' | translate }}</h2>
  <mat-dialog-content>{{ 'DASHBOARD.LOGOUT_CONFIRM' | translate }}</mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>{{ 'DASHBOARD.CANCEL' | translate }}</button>
    <button mat-button color="warn" [mat-dialog-close]="'confirm'">{{ 'DASHBOARD.LOGOUT_BUTTON' | translate }}</button>
  </mat-dialog-actions>
</ng-template>

<!-- Review Changes Dialog -->
<ng-template #reviewDialog let-data>
  <h2 mat-dialog-title>{{ 'DASHBOARD.REVIEW_CHANGES_TITLE' | translate }}</h2>
  <mat-dialog-content>
    <table class="mat-elevation-z2 w-full">
      <thead>
        <tr>
          <th>{{ 'DASHBOARD.USER_ID' | translate }}</th>
          <th>{{ 'DASHBOARD.NAME' | translate }}</th>
          <th>{{ 'DASHBOARD.EMAIL' | translate }}</th>
          <th>{{ 'DASHBOARD.ROLE' | translate }}</th>
          <th>{{ 'DASHBOARD.STATUS' | translate }}</th>
        </tr>
      </thead>
      <tbody>
        @for (u of data.newUsers; track u._id) {
          <tr>
            <td>{{ u.userId }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.role }}</td>
            <td>{{ 'DASHBOARD.STATUS_NEW' | translate }}</td>
          </tr>
        }
        @for (u of data.updatedUsers; track u._id) {
          <tr>
            <td>{{ u.userId }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.role }}</td>
            <td>{{ 'DASHBOARD.STATUS_UPDATED' | translate }}</td>
          </tr>
        }
        @for (u of data.deletedUsers; track u._id) {
          <tr class="deleted-row">
            <td>{{ u.userId }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.role }}</td>
            <td>{{ 'DASHBOARD.STATUS_DELETED' | translate }}</td>
          </tr>
        }
      </tbody>
    </table>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>{{ 'DASHBOARD.CANCEL' | translate }}</button>
    <button mat-button color="primary" (click)="saveChanges(data)" mat-dialog-close>{{ 'DASHBOARD.CONFIRM_SAVE' | translate }}</button>
  </mat-dialog-actions>
</ng-template>
